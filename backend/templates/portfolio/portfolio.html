{% load static i18n %}
{% load static humanize %}

<!-- Filters Section -->
<section class="filters-section pt150 pt50-xs pb30">
  <div class="container">
    <div class="filters-header d-flex justify-content-between align-items-center mb30">
      <h2 class="filters-title">All projects</h2>
      <button type="button" class="filters-clear" id="clearAllFilters">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M1 1L11 11M11 1L1 11" stroke="currentColor" stroke-width="1.5"/>
        </svg>
        Clear all
      </button>
    </div>

    <!-- Filters Row -->
    <div class="filters-row">
      <!-- Unit Type -->
      <div class="filter-dropdown" data-filter="type">
        <button class="filter-pill" type="button">
          <span class="pill-text">Unit Type</span>
          <svg class="pill-arrow" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
        <div class="filter-dropdown-menu">
          {% for pt in property_types %}
          <label class="filter-option">
            <input type="checkbox" value="{{ pt.slug }}">
            {% if pt.icon %}<span class="option-icon">{{ pt.icon }}</span>{% endif %}
            {{ pt.name }}
          </label>
          {% empty %}
          <label class="filter-option"><input type="checkbox" value="villa"><span class="option-icon">üè†</span>Villa</label>
          <label class="filter-option"><input type="checkbox" value="apartment"><span class="option-icon">üè¢</span>Apartment</label>
          {% endfor %}
        </div>
      </div>

      <!-- Bedrooms -->
      <div class="filter-dropdown" data-filter="bedrooms">
        <button class="filter-pill" type="button">
          <span class="pill-text">Bedrooms</span>
          <svg class="pill-arrow" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
        <div class="filter-dropdown-menu filter-dropdown-menu--circles">
          <div class="bedrooms-row">
            <button class="bed-circle" type="button" data-value="1">1</button>
            <button class="bed-circle" type="button" data-value="2">2</button>
            <button class="bed-circle" type="button" data-value="3">3</button>
            <button class="bed-circle" type="button" data-value="4">4</button>
            <button class="bed-circle" type="button" data-value="5+">5+</button>
          </div>
        </div>
      </div>

      <!-- Price -->
      <div class="filter-dropdown" data-filter="price">
        <button class="filter-pill" type="button">
          <span class="pill-text">Price</span>
          <svg class="pill-arrow" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
        <div class="filter-dropdown-menu">
          <label class="filter-option"><input type="checkbox" value="0-100000">Up to $100,000</label>
          <label class="filter-option"><input type="checkbox" value="100000-200000">$100,000 - $200,000</label>
          <label class="filter-option"><input type="checkbox" value="200000-300000">$200,000 - $300,000</label>
          <label class="filter-option"><input type="checkbox" value="300000-500000">$300,000 - $500,000</label>
          <label class="filter-option"><input type="checkbox" value="500000-1000000">$500,000 - $1,000,000</label>
          <label class="filter-option"><input type="checkbox" value="1000000+">$1,000,000+</label>
        </div>
      </div>

      <!-- Area -->
      <div class="filter-dropdown" data-filter="area">
        <button class="filter-pill" type="button">
          <span class="pill-text">Area</span>
          <svg class="pill-arrow" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
        <div class="filter-dropdown-menu">
          <label class="filter-option"><input type="checkbox" value="0-50">Up to 50 m¬≤</label>
          <label class="filter-option"><input type="checkbox" value="50-100">50 - 100 m¬≤</label>
          <label class="filter-option"><input type="checkbox" value="100-200">100 - 200 m¬≤</label>
          <label class="filter-option"><input type="checkbox" value="200-500">200 - 500 m¬≤</label>
          <label class="filter-option"><input type="checkbox" value="500+">500+ m¬≤</label>
        </div>
      </div>

      <!-- Location -->
      <div class="filter-dropdown" data-filter="location">
        <button class="filter-pill" type="button">
          <span class="pill-text">Location</span>
          <svg class="pill-arrow" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
        <div class="filter-dropdown-menu">
          <label class="filter-option"><input type="checkbox" value="canggu">Canggu</label>
          <label class="filter-option"><input type="checkbox" value="seminyak">Seminyak</label>
          <label class="filter-option"><input type="checkbox" value="ubud">Ubud</label>
          <label class="filter-option"><input type="checkbox" value="bukit">Bukit</label>
          <label class="filter-option"><input type="checkbox" value="uluwatu">Uluwatu</label>
          <label class="filter-option"><input type="checkbox" value="sanur">Sanur</label>
          <label class="filter-option"><input type="checkbox" value="nusa-dua">Nusa Dua</label>
        </div>
      </div>

      <!-- Sale Status -->
      <div class="filter-dropdown" data-filter="status">
        <button class="filter-pill" type="button">
          <span class="pill-text">Sale Status</span>
          <svg class="pill-arrow" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
        <div class="filter-dropdown-menu">
          <label class="filter-option"><input type="checkbox" value="presale">Pre-sale</label>
          <label class="filter-option"><input type="checkbox" value="selling">Selling</label>
          <label class="filter-option"><input type="checkbox" value="soldout">Sold Out</label>
        </div>
      </div>

      <!-- Features -->
      <div class="filter-dropdown" data-filter="features">
        <button class="filter-pill" type="button">
          <span class="pill-text">Features</span>
          <svg class="pill-arrow" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
        <div class="filter-dropdown-menu">
          <label class="filter-option"><input type="checkbox" value="pool"><span class="option-icon">üèä</span>Pool</label>
          <label class="filter-option"><input type="checkbox" value="ocean_view"><span class="option-icon">üåä</span>Ocean View</label>
          <label class="filter-option"><input type="checkbox" value="gym"><span class="option-icon">üèãÔ∏è</span>Gym</label>
          <label class="filter-option"><input type="checkbox" value="parking"><span class="option-icon">üöó</span>Parking</label>
          <label class="filter-option"><input type="checkbox" value="security"><span class="option-icon">üîí</span>Security</label>
          <label class="filter-option"><input type="checkbox" value="garden"><span class="option-icon">üå¥</span>Garden</label>
        </div>
      </div>

      <!-- Construction -->
      <div class="filter-dropdown" data-filter="construction">
        <button class="filter-pill" type="button">
          <span class="pill-text">Construction</span>
          <svg class="pill-arrow" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
        <div class="filter-dropdown-menu">
          <label class="filter-option"><input type="checkbox" value="not_started">Not Started</label>
          <label class="filter-option"><input type="checkbox" value="in_progress">In Progress</label>
          <label class="filter-option"><input type="checkbox" value="completed">Completed</label>
          <label class="filter-option"><input type="checkbox" value="on_hold">On Hold</label>
        </div>
      </div>

      <!-- Ownership -->
      <div class="filter-dropdown filter-dropdown--ownership" data-filter="ownership">
        <div class="filter-label-inline">OWNERSHIP</div>
        <div class="ownership-pills">
          <button class="ownership-pill" type="button" data-value="freehold">Freehold</button>
          <button class="ownership-pill" type="button" data-value="leasehold">Leasehold</button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="filter-results mt20">
      <span id="resultsCount">{{ properties.count|default:"0" }}</span> properties found
    </div>
  </div>
</section>

<!-- Properties Grid Section -->
<section class="projects section-projects2 pt50 pb100">
  <div class="container">
    <div class="projects-grid" id="propertiesGrid">
      {% for prop in properties %}
      <a href="#" class="project-card project-card--lg{% if forloop.counter == 2 or forloop.counter == 6 or forloop.counter == 10 %} project-card--align-end{% endif %}"
         data-id="{{ prop.id }}">
        <div class="pc-img" style="--img:url('{% if prop.image %}{{ prop.image.url }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}')">
          <div class="pc-tags">
            <span class="tag">{{ prop.property_type.name|default:"Property" }}</span>
            {% if prop.price_min %}
            <span class="tag">From ${{ prop.price_min|floatformat:0|intcomma }}</span>
            {% endif %}
          </div>
        </div>
        <div class="pc-meta">
          <h3 class="pc-title">
            <span class="dot" aria-hidden="true"></span>
            {{ prop.title }}
            <i class="wdt-button__icon" aria-hidden="true"></i>
          </h3>
          <div class="pc-loc">{% if prop.location.name %}{{ prop.location.name }}, Bali{% else %}Bali{% endif %}</div>
        </div>
      </a>
      {% empty %}
      <div class="no-results"><p>No properties found</p></div>
      {% endfor %}
    </div>
    <div class="properties-pagination mt50" id="propertiesPagination"></div>
  </div>
</section>

<!-- Property Modal -->
<div id="propertyModal" class="property-modal">
  <div class="property-modal__overlay"></div>
  <div class="property-modal__content">
    <button class="property-modal__close">
      <svg width="21" height="21" viewBox="0 0 21 21" fill="none">
        <path d="M5.5 5.5L15.5 15.5M15.5 5.5L5.5 15.5" stroke="white" stroke-width="1"/>
      </svg>
    </button>

    <div class="pm-image"><img src="" alt="Property"></div>

    <div class="pm-wrapper">
      <div class="row gx-5">
        <div class="col-12 col-lg-4 mb30">
          <div class="pm-header">
            <h2 class="pm-title"></h2>
            <span class="pm-type"></span>
            <div class="pm-header__actions mt20">
              <a class="wdt-button button-cta is-nm concierge-cta" href="#contact">
                <span>Contact us</span>
                <i class="wdt-button__icon" aria-hidden="true"></i>
              </a>
              <button class="favorites-btn" aria-label="Add to favorites">
                <span class="flaticon-like"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <!-- Complex layout -->
          <div class="pm-info-grid pm-info-grid--complex">
            <div class="pm-info-col">
              <div class="pm-info-item">
                <div class="pm-info__label">Location</div>
                <div class="pm-info__value pm-location"></div>
              </div>
              <div class="pm-info-item">
                <div class="pm-info__label">Construction</div>
                <div class="pm-info__value pm-construction"></div>
              </div>
              <div class="pm-info-item">
                <div class="pm-info__label">ROI</div>
                <div class="pm-info__value pm-roi"></div>
              </div>
            </div>
            <div class="pm-info-col">
              <div class="pm-info-item">
                <div class="pm-info__label">Total units</div>
                <div class="pm-info__value pm-units-count"></div>
              </div>
              <div class="pm-info-item">
                <div class="pm-info__label">Views</div>
                <div class="pm-info__value pm-views"></div>
              </div>
            </div>
          </div>
          <!-- Single property layout -->
          <div class="pm-info-grid pm-info-grid--single">
            <div class="pm-info-col">
              <div class="pm-info-item">
                <div class="pm-info__label">Location</div>
                <div class="pm-info__value pm-location-single"></div>
              </div>
              <div class="pm-info-item">
                <div class="pm-info__label">Construction</div>
                <div class="pm-info__value pm-construction-single"></div>
              </div>
              <div class="pm-info-item">
                <div class="pm-info__label">ROI</div>
                <div class="pm-info__value pm-roi-single"></div>
              </div>
            </div>
            <div class="pm-info-col">
              <div class="pm-info-item">
                <div class="pm-info__label">Total area</div>
                <div class="pm-info__value pm-area"></div>
              </div>
              <div class="pm-info-item">
                <div class="pm-info__label">Leasehold</div>
                <div class="pm-info__value pm-leasehold"></div>
              </div>
              <div class="pm-info-item">
                <div class="pm-info__label">Price</div>
                <div class="pm-info__value pm-price"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="pm-separator"></div>

    <!-- Units section (for complex) -->
    <div class="pm-wrapper pm-units-section">
      <div class="row gx-5">
        <div class="col-12 col-lg-4 mb30">
          <h3 class="pm-section-title">Unit types and prices</h3>
        </div>
        <div class="col-12 col-lg-8">
          <div class="pm-units" id="pmUnitsGrid"></div>
        </div>
      </div>
    </div>

    <!-- Features section (for single) -->
    <div class="pm-wrapper pm-features-section">
      <div class="row gx-5">
        <div class="col-12 col-lg-4 mb30">
          <h3 class="pm-section-title">Features</h3>
        </div>
        <div class="col-12 col-lg-8">
          <div class="pm-features" id="pmFeatures"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Bottom Sheet -->
<div id="mobileFilterOverlay" class="mobile-filter-overlay"></div>
<div id="mobileFilterSheet" class="mobile-filter-sheet"></div>
<style>
/* ===== FILTERS ===== */
.filters-section { position: relative; z-index: 10; }
.filters-section .container { overflow: visible; }
.filters-header { margin-bottom: 30px; }
.filters-title { font-family: 'Manrope', sans-serif; font-weight: 600; font-size: 32px; color: #fff; margin: 0; }
.filters-clear { display: flex; align-items: center; gap: 8px; background: transparent; border: none; color: rgba(255,255,255,0.5); font-family: 'Manrope', sans-serif; font-size: 14px; cursor: pointer; transition: color 0.2s; }
.filters-clear:hover { color: #EA9278; }
.filters-row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; position: relative; }
.filter-dropdown { position: relative; }
.filter-pill { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 100px; font-family: 'Manrope', sans-serif; font-weight: 500; font-size: 14px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.filter-pill:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: #fff; }
.filter-dropdown.is-open .filter-pill, .filter-dropdown.has-value .filter-pill { background: linear-gradient(90deg, #F0987D 0%, #CE7F63 50%, #EA9278 100%); border-color: transparent; color: #fff; }
.pill-arrow { transition: transform 0.2s; stroke: currentColor; }
.filter-dropdown.is-open .pill-arrow { transform: rotate(180deg); }
.filter-dropdown-menu { position: absolute; top: calc(100% + 8px); left: 0; min-width: 230px; background: #323232; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); padding: 12px; z-index: 1001; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease; }
.filter-dropdown.is-open .filter-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
.filter-option { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; cursor: pointer; transition: background 0.15s; font-family: 'Manrope', sans-serif; font-size: 14px; color: rgba(255,255,255,0.8); }
.filter-option:hover { background: rgba(255,255,255,0.08); }
.filter-option input[type="checkbox"] { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; background: transparent; appearance: none; -webkit-appearance: none; cursor: pointer; transition: all 0.15s; flex-shrink: 0; }
.filter-option input[type="checkbox"]:checked { background: linear-gradient(90deg, #F0987D 0%, #EA9278 100%); border-color: #EA9278; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 14 14' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 4L5.5 9.5L3 7' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-position: center; background-repeat: no-repeat; }
.option-icon { font-size: 16px; }
.filter-dropdown-menu--circles { padding: 16px; }
.bedrooms-row { display: flex; gap: 8px; }
.bed-circle { width: 40px; height: 40px; border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; background: rgba(255,255,255,0.05); font-family: 'Manrope', sans-serif; font-weight: 600; font-size: 14px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.15s; }
.bed-circle:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: #fff; }
.bed-circle.is-selected { background: linear-gradient(90deg, #F0987D 0%, #EA9278 100%); border-color: transparent; color: #fff; }
.filter-dropdown--ownership { display: flex; align-items: center; gap: 12px; }
.filter-label-inline { font-family: 'Manrope', sans-serif; font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.4); letter-spacing: 0.5px; text-transform: uppercase; }
.ownership-pills { display: flex; gap: 6px; }
.ownership-pill { padding: 8px 16px; border: 1px solid rgba(255,255,255,0.15); border-radius: 100px; background: rgba(255,255,255,0.05); font-family: 'Manrope', sans-serif; font-size: 13px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.15s; }
.ownership-pill:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: #fff; }
.ownership-pill.is-selected { background: linear-gradient(90deg, #F0987D 0%, #EA9278 100%); border-color: transparent; color: #fff; }
.filter-results { font-family: 'Manrope', sans-serif; font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 20px; }
.filter-results span { color: #EA9278; font-weight: 600; }
.no-results { grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.6); }

/* ===== MOBILE BOTTOM SHEET ===== */
.mobile-filter-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99998; backdrop-filter: blur(4px); }
.mobile-filter-overlay.is-active { display: block; }
.mobile-filter-sheet { display: none; position: fixed; left: 0; right: 0; bottom: 0; background: #323232; border-radius: 20px 20px 0 0; padding: 16px 20px 40px; max-height: 70vh; overflow-y: auto; z-index: 99999; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1); }
.mobile-filter-sheet.is-active { display: block; transform: translateY(0); }
.mobile-filter-sheet::before { content: ''; display: block; width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin: 0 auto 20px; }

/* ===== MODAL ===== */
.property-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: none; opacity: 0; transition: opacity 0.3s ease; }
.property-modal.is-active { display: flex; align-items: center; justify-content: center; opacity: 1; }
body.modal-open { overflow: hidden; }
body.modal-open header.nav-homepage-style { z-index: 1 !important; }
.property-modal__overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
.property-modal__content { position: relative; width: 900px; max-width: 95%; max-height: 90vh; background: #272727; border-radius: 30px; overflow-y: auto; z-index: 1; scrollbar-width: thin; scrollbar-color: #E08A72 rgba(0,0,0,0.2); }
.property-modal__close { position: absolute; top: 30px; right: 15px; width: 21px; height: 21px; background: transparent; border: none; cursor: pointer; z-index: 10; padding: 0; }
.pm-image { padding: 40px 50px 30px; }
.pm-image img { width: 100%; height: 333px; object-fit: cover; border-radius: 30px; }
.pm-wrapper { padding: 40px 50px 30px; }
.pm-title { font-weight: 600; font-size: 18px; background: linear-gradient(90deg, #F0987D 0%, #CE7F63 50%, #EA9278 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0 0 5px; }
.pm-type { font-weight: 500; font-size: 14px; color: rgba(255,255,255,0.6); }
.pm-header__actions { display: flex; gap: 11px; }
.pm-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
.pm-info-col { display: flex; flex-direction: column; gap: 30px; }
.pm-info__label { font-weight: 600; font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 10px; }
.pm-info__value { font-weight: 500; font-size: 12px; line-height: 1.4; color: #fff; }
.pm-separator { width: calc(100% - 100px); height: 1px; background: rgba(255,255,255,0.2); margin: 0 50px 20px; }
.pm-section-title { font-weight: 600; font-size: 12px; color: rgba(255,255,255,0.5); margin: 0; }

/* Mode switching */
.pm-info-grid--complex, .pm-info-grid--single { display: none; grid-template-columns: 1fr 1fr; gap: 30px; }
.pm-units-section, .pm-features-section { display: none; }

/* Units */
.pm-units { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
.pm-unit { background: #232323; border-radius: 25px; padding: 20px; box-shadow: 0 0 7.5px rgba(0,0,0,0.5); }
.pm-unit__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.pm-unit__type { font-weight: 500; font-size: 12px; background: linear-gradient(90deg, #F0987D 0%, #EA9278 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.pm-unit__fav { background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; padding: 0; font-size: 14px; transition: color 0.2s; }
.pm-unit__fav:hover { color: #EA9278; }
.pm-unit__details { list-style: none; padding: 0; margin: 0 0 10px; }
.pm-unit__details li { position: relative; padding-left: 12px; font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 4px; }
.pm-unit__details li::before { content: '‚Ä¢'; position: absolute; left: 0; color: rgba(255,255,255,0.3); }
.pm-unit__price { font-weight: 500; font-size: 12px; color: rgba(255,255,255,0.5); }
.pm-no-units { grid-column: 1 / -1; text-align: center; color: rgba(255,255,255,0.5); padding: 20px; }

/* Features */
.pm-features-list { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 10px; }
.pm-features-list li { background: rgba(255,255,255,0.08); padding: 8px 16px; border-radius: 20px; font-size: 13px; color: rgba(255,255,255,0.8); }
.pm-no-features { color: rgba(255,255,255,0.5); }

/* Views list */
.pm-views-list { list-style: none; padding: 0; margin: 0; }
.pm-views-list li { position: relative; padding-left: 16px; margin-bottom: 4px; font-size: 12px; }
.pm-views-list li::before { content: '‚Ä¢'; position: absolute; left: 0; color: #EA9278; }

/* ===== MOBILE ===== */
@media (max-width: 768px) {
  .filters-section.pt150 { padding-top: 100px; }
  .filters-title { font-size: 24px; }
  .filters-row { flex-wrap: nowrap; overflow-x: auto; gap: 8px; padding-bottom: 12px; margin: 0 -15px; padding-left: 15px; padding-right: 15px; scrollbar-width: none; }
  .filters-row::-webkit-scrollbar { display: none; }
  .filter-pill { padding: 8px 14px; font-size: 13px; flex-shrink: 0; }
  .filter-dropdown-menu { display: none !important; }
  .property-modal__content { width: 100%; max-width: 100%; max-height: 100vh; border-radius: 0; }
  .pm-image { padding: 0; }
  .pm-image img { height: 250px; border-radius: 0; }
  .pm-wrapper { padding: 30px 25px 25px; }
  .pm-info-grid, .pm-info-grid--complex, .pm-info-grid--single { grid-template-columns: 1fr; gap: 20px; }
  .pm-separator { width: calc(100% - 50px); margin: 0 25px 15px; }
  .pm-units { grid-template-columns: 1fr; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('propertyModal');
  const isMobile = () => window.innerWidth <= 768;
  const overlay = document.getElementById('mobileFilterOverlay');
  const sheet = document.getElementById('mobileFilterSheet');
  
  const filterState = { type: [], bedrooms: [], price: [], area: [], location: [], status: [], features: [], construction: [], ownership: [] };

  // === FILTERS ===
  function closeAllDropdowns() {
    document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('is-open'));
    if (isMobile()) { overlay.classList.remove('is-active'); sheet.classList.remove('is-active'); document.body.style.overflow = ''; }
  }

  function openDropdown(dropdown) {
    const menu = dropdown.querySelector('.filter-dropdown-menu');
    closeAllDropdowns();
    dropdown.classList.add('is-open');
    if (isMobile() && menu) {
      sheet.innerHTML = menu.innerHTML;
      overlay.classList.add('is-active');
      document.body.style.overflow = 'hidden';
      requestAnimationFrame(() => sheet.classList.add('is-active'));
    }
  }

  document.querySelectorAll('.filter-pill').forEach(pill => {
    pill.addEventListener('click', function(e) {
      e.preventDefault();
      const dropdown = this.closest('.filter-dropdown');
      dropdown.classList.contains('is-open') ? closeAllDropdowns() : openDropdown(dropdown);
    });
  });

  document.querySelectorAll('.filter-dropdown-menu input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
      const dropdown = this.closest('.filter-dropdown');
      const filterName = dropdown.dataset.filter;
      this.checked ? filterState[filterName].push(this.value) : filterState[filterName] = filterState[filterName].filter(v => v !== this.value);
      updatePillState(dropdown);
      applyFilters();
    });
  });

  document.querySelectorAll('.bed-circle').forEach(circle => {
    circle.addEventListener('click', function(e) {
      e.preventDefault();
      const dropdown = this.closest('.filter-dropdown');
      dropdown.querySelectorAll('.bed-circle').forEach(c => c.classList.remove('is-selected'));
      this.classList.add('is-selected');
      filterState.bedrooms = [this.dataset.value];
      updatePillState(dropdown);
      applyFilters();
    });
  });

  document.querySelectorAll('.ownership-pill').forEach(pill => {
    pill.addEventListener('click', function(e) {
      e.preventDefault();
      this.classList.toggle('is-selected');
      const value = this.dataset.value;
      this.classList.contains('is-selected') ? filterState.ownership.push(value) : filterState.ownership = filterState.ownership.filter(v => v !== value);
      applyFilters();
    });
  });

  overlay?.addEventListener('click', closeAllDropdowns);
  document.addEventListener('click', e => { if (!isMobile() && !e.target.closest('.filter-dropdown')) closeAllDropdowns(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeAllDropdowns(); closeModal(); } });

  function updatePillState(dropdown) {
    const filterName = dropdown.dataset.filter;
    const hasValue = filterState[filterName].length > 0;
    dropdown.classList.toggle('has-value', hasValue);
    const pillText = dropdown.querySelector('.pill-text');
    if (pillText) pillText.textContent = pillText.textContent.split(' (')[0] + (hasValue ? ` (${filterState[filterName].length})` : '');
  }

  document.getElementById('clearAllFilters')?.addEventListener('click', function() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('.bed-circle, .ownership-pill').forEach(el => el.classList.remove('is-selected'));
    document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('has-value'));
    document.querySelectorAll('.pill-text').forEach(pt => pt.textContent = pt.textContent.split(' (')[0]);
    Object.keys(filterState).forEach(key => filterState[key] = []);
    applyFilters();
  });

  function applyFilters() {
    const params = new URLSearchParams();
    Object.entries(filterState).forEach(([key, val]) => { if (val.length) params.set(key, val.join(',')); });
    const grid = document.getElementById('propertiesGrid');
    if (grid) { grid.style.opacity = '0.5'; grid.style.pointerEvents = 'none'; }

    fetch(`/api/properties/?${params.toString()}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('resultsCount').textContent = data.total || 0;
        if (grid) { grid.style.opacity = '1'; grid.style.pointerEvents = ''; if (data.results) renderProperties(data.results); }
      })
      .catch(() => { if (grid) { grid.style.opacity = '1'; grid.style.pointerEvents = ''; } });
  }

  function renderProperties(properties) {
    const grid = document.getElementById('propertiesGrid');
    if (!grid) return;
    if (!properties.length) { grid.innerHTML = '<div class="no-results"><p>No properties found</p></div>'; return; }

    grid.innerHTML = properties.map((prop, i) => `
      <a href="#" class="project-card project-card--lg${i % 4 === 1 ? ' project-card--align-end' : ''}" data-id="${prop.id}">
        <div class="pc-img" style="--img:url('${prop.image || '/static/images/placeholder.jpg'}')">
          <div class="pc-tags">
            <span class="tag">${prop.property_type || 'Property'}</span>
            ${prop.price_display ? `<span class="tag">${prop.price_display}</span>` : ''}
          </div>
        </div>
        <div class="pc-meta">
          <h3 class="pc-title"><span class="dot"></span>${prop.title}<i class="wdt-button__icon"></i></h3>
          <div class="pc-loc">${prop.location ? prop.location + ', Bali' : 'Bali'}</div>
        </div>
      </a>
    `).join('');
    initPropertyModals();
  }

  // === MODAL ===
  function closeModal() {
    modal?.classList.remove('is-active');
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
  }

  function initPropertyModals() {
    document.querySelectorAll('.project-card[data-id]').forEach(card => {
      card.addEventListener('click', function(e) {
        e.preventDefault();
        const id = this.dataset.id;
        if (id) loadPropertyData(id);
      });
    });
  }

  window.loadPropertyData = function(id) {
    fetch(`/api/properties/${id}/`)
      .then(r => r.json())
      .then(data => {
        const isComplex = data.is_complex;
        
        modal.querySelector('.pm-title').textContent = data.title || '';
        modal.querySelector('.pm-type').textContent = data.property_type || '';
        modal.querySelector('.pm-image img').src = data.image || '';
        
        // Toggle mode
        modal.querySelector('.pm-info-grid--complex').style.display = isComplex ? 'grid' : 'none';
        modal.querySelector('.pm-info-grid--single').style.display = isComplex ? 'none' : 'grid';
        modal.querySelector('.pm-units-section').style.display = isComplex ? 'block' : 'none';
        modal.querySelector('.pm-features-section').style.display = isComplex ? 'none' : 'block';
        
        if (isComplex) {
          modal.querySelector('.pm-location').textContent = data.location || '‚Äî';
          modal.querySelector('.pm-construction').innerHTML = data.construction || '‚Äî';
          modal.querySelector('.pm-roi').textContent = data.roi || '‚Äî';
          modal.querySelector('.pm-units-count').textContent = data.total_units || '‚Äî';
          
          const viewsEl = modal.querySelector('.pm-views');
          if (data.features && data.features.length) {
            viewsEl.innerHTML = '<ul class="pm-views-list">' + data.features.map(f => `<li>${f}</li>`).join('') + '</ul>';
          } else { viewsEl.textContent = '‚Äî'; }
          
          const unitsGrid = document.getElementById('pmUnitsGrid');
          if (data.units && data.units.length) {
            unitsGrid.innerHTML = data.units.map(u => `
              <div class="pm-unit">
                <div class="pm-unit__header">
                  <span class="pm-unit__type">${u.type}</span>
                  <button class="pm-unit__fav"><span class="flaticon-like"></span></button>
                </div>
                <ul class="pm-unit__details">${u.details.split(' ‚Ä¢ ').map(d => `<li>${d}</li>`).join('')}</ul>
                <div class="pm-unit__price">${u.price}</div>
              </div>
            `).join('');
          } else { unitsGrid.innerHTML = '<div class="pm-no-units">Contact us for details</div>'; }
        } else {
          modal.querySelector('.pm-location-single').textContent = data.location || '‚Äî';
          modal.querySelector('.pm-construction-single').innerHTML = data.construction || '‚Äî';
          modal.querySelector('.pm-roi-single').textContent = data.roi || '‚Äî';
          modal.querySelector('.pm-area').textContent = data.total_area || '‚Äî';
          modal.querySelector('.pm-leasehold').textContent = data.leasehold ? `${data.leasehold} years` : '‚Äî';
          modal.querySelector('.pm-price').textContent = data.price_display || '‚Äî';
          
          const featuresEl = document.getElementById('pmFeatures');
          if (data.features && data.features.length) {
            featuresEl.innerHTML = '<ul class="pm-features-list">' + data.features.map(f => `<li>${f}</li>`).join('') + '</ul>';
          } else { featuresEl.innerHTML = '<div class="pm-no-features">‚Äî</div>'; }
        }
        
        modal.classList.add('is-active');
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
      })
      .catch(err => console.error('Error:', err));
  };

  modal?.querySelector('.property-modal__overlay')?.addEventListener('click', closeModal);
  modal?.querySelector('.property-modal__close')?.addEventListener('click', closeModal);
  
  initPropertyModals();
});
</script>